"use strict";
var Encoder;
(function (Encoder) {
    class Code {
        constructor() {
            this.types = [];
            this.prototypes = [];
        }
        add(type) {
            if (!this.prototypes.some(x => x.hash === type.prototype.hash))
                this.prototypes.push(type.prototype);
            const id = this.types.push(type) - 1;
            type.transfer(this);
            return id;
        }
        link() {
            for (const type of this.types) {
                const container = type.container;
                if (container) {
                    const containerType = container.type;
                    if (containerType)
                        containerType.contents.add(Encoder.FutureType.$(type));
                }
            }
        }
        extractData(pattern) {
            const dataRoots = this.types.filter(x => x.container === null && pattern.test(x.name));
            const drill = (x) => {
                const array = [x];
                for (const content of x.contents) {
                    const type = content.type;
                    if (type) {
                        const child = drill(type).flat();
                        if (child.length)
                            array.push(...child);
                    }
                }
                return array;
            };
            const dataSchema = dataRoots.map(drill).filter(x => Array.isArray(x) ? x.length : true);
            const dataQuery = dataSchema.flat();
            const codeRoots = this.types.filter(x => !dataQuery.includes(x));
            const code = new Code();
            for (const type of codeRoots)
                code.add(type);
            for (const type of dataQuery) {
                if (!code.prototypes.some(x => x.hash === type.prototype.hash))
                    code.prototypes.push(type.prototype);
                type.transfer(code);
            }
            const data = dataSchema.map(x => [x.map(x => x.prototype.id), x[0].name, ...x.map(x => x.aliases)]);
            return {
                code,
                data
            };
        }
        toJSON() { return [this.prototypes, this.types]; }
        valueOf() { return this.types.length; }
        [Symbol.toPrimitive]() { return this.types.length; }
        get [Symbol.toStringTag]() { return "Code"; }
    }
    Encoder.Code = Code;
})(Encoder || (Encoder = {}));
var Encoder;
(function (Encoder) {
    class FutureType {
        constructor(value) {
            this.value = value;
        }
        static $(value) {
            const cached = FutureType.Cache.get(value);
            if (cached)
                return cached;
            const instance = new FutureType(value);
            FutureType.Cache.set(value, instance);
            return instance;
        }
        get type() {
            if (this.value instanceof Truth.Type) {
                const type = FutureType.TypeMap.get(this.value);
                if (!type)
                    return null;
                return type;
            }
            if (this.value instanceof Encoder.Type)
                return this.value;
            return FutureType.IdMap.get(this.value) || null;
        }
        get id() {
            if (this.value instanceof Truth.Type) {
                const type = FutureType.TypeMap.get(this.value);
                if (!type)
                    return -1;
                return type.id;
            }
            if (this.value instanceof Encoder.Type)
                return this.value.id;
            return this.value;
        }
        is(type) {
            const valueType = this.value;
            if (!valueType)
                return false;
            return valueType === type;
        }
        toJSON() { return this.id; }
        valueOf() { return this.id; }
        [Symbol.toPrimitive]() { return this.id; }
        get [Symbol.toStringTag]() { return "FutureType"; }
    }
    FutureType.Cache = new Map();
    FutureType.TypeMap = new Map();
    FutureType.IdMap = new Map();
    Encoder.FutureType = FutureType;
})(Encoder || (Encoder = {}));
var Encoder;
(function (Encoder) {
    class Prototype {
        constructor(code, flags, bases = new Encoder.TypeSet(), patterns = new Encoder.TypeSet(), parallels = new Encoder.TypeSet(), contentsIntrinsic = new Encoder.TypeSet()) {
            this.code = code;
            this.flags = flags;
            this.bases = bases;
            this.patterns = patterns;
            this.parallels = parallels;
            this.contentsIntrinsic = contentsIntrinsic;
        }
        static fromTruth(code, type) {
            const flags = new Backer.Bitfields();
            flags.set(0, type.isAnonymous);
            flags.set(1, type.isFresh);
            flags.set(2, type.isList);
            flags.set(3, type.isListIntrinsic);
            flags.set(4, type.isListExtrinsic);
            flags.set(5, type.isPattern);
            flags.set(6, type.isUri);
            flags.set(7, type.isSpecified);
            let proto = new Prototype(code, flags, new Encoder.TypeSet(type.bases.map(Encoder.FutureType.$)), new Encoder.TypeSet(type.patterns.map(Encoder.FutureType.$)), new Encoder.TypeSet(type.parallels.map(Encoder.FutureType.$)), new Encoder.TypeSet(type.contentsIntrinsic.map(Encoder.FutureType.$)));
            const ex = code.prototypes.find(x => x.hash === proto.hash);
            if (ex)
                proto = ex;
            return proto;
        }
        get id() {
            return this.code.prototypes.indexOf(this);
        }
        get hash() {
            return Backer.Util.hash(JSON.stringify(this));
        }
        transfer(code) {
            this.code = code;
        }
        toJSON() {
            return Backer.Serializer.encode([
                this.flags, this.bases, this.patterns, this.parallels, this.contentsIntrinsic
            ]);
        }
    }
    Encoder.Prototype = Prototype;
})(Encoder || (Encoder = {}));
var Encoder;
(function (Encoder) {
    Encoder.Header = "";
    async function compile(configPath) {
        const join = require("path").join;
        if (!configPath.endsWith("truthconfig.js"))
            configPath = join(configPath, "/truthconfig.js");
        const config = Encoder.safe(() => require(configPath), "Couldn't read config file!");
        const truthfiles = Encoder.safe(() => Truth.Fs.module.readdirSync(join(process.cwd(), config.SourceDir)), "Couldn't read source folder!", true).filter(x => x.endsWith(".truth"));
        const content = [
            config.Backer ? Encoder.Header : "",
            ...truthfiles.map(x => Encoder.safe(() => Truth.Fs.module.readFileSync(join(process.cwd(), x), "utf-8"), "Couldn't read truth file!"))
        ].join("\n");
        const document = await Truth.parse(content);
        document.program.verify();
        for (const fault of document.program.faults.each())
            console.error(fault.toString());
        let code = new Encoder.Code();
        const drill = (type) => {
            code.add(Encoder.Type.fromTruth(code, type));
            for (const sub of type.contents)
                drill(sub);
        };
        for (const type of document.types)
            drill(type);
        code.link();
        for (const key in config.DataPatterns) {
            let temp = code.extractData(config.DataPatterns[key]);
            code = temp.code;
            Encoder.safe(() => Truth.Fs.module.writeFileSync(join(process.cwd(), config.TargetDir, key + ".data.json"), Encoder.stringify(temp.data)), "Couldn't read source folder!", true);
        }
        Encoder.safe(() => Truth.Fs.module.writeFileSync(join(process.cwd(), config.TargetDir, "code.json"), Encoder.stringify(code)), "Couldn't read source folder!", true);
    }
    Encoder.compile = compile;
})(Encoder || (Encoder = {}));
var Encoder;
(function (Encoder) {
    class Type {
        constructor(code, name, prototype, container = null, aliases = []) {
            this.code = code;
            this.name = name;
            this.prototype = prototype;
            this.container = container;
            this.aliases = aliases;
            this.contents = new Encoder.TypeSet();
        }
        static fromTruth(code, type) {
            const instance = new Type(code, type.isPattern ? type.name.substr(9) : type.name, Encoder.Prototype.fromTruth(code, type), type.container ? Encoder.FutureType.$(type.container) : null, type.aliases);
            Encoder.FutureType.TypeMap.set(type, instance);
            return instance;
        }
        get id() {
            return this.code.types.indexOf(this);
        }
        transfer(code) {
            this.code = code;
            this.prototype.transfer(code);
        }
        toJSON() {
            return [this.prototype.id, this.container, this.name, this.aliases];
        }
    }
    Encoder.Type = Type;
})(Encoder || (Encoder = {}));
var Encoder;
(function (Encoder) {
    class TypeSet extends Set {
        toArray() {
            return Array.from(this.values()).sort();
        }
        toJSON() { return this.toArray(); }
        valueOf() { return this.toArray(); }
        [Symbol.toPrimitive]() { return this.toArray(); }
        get [Symbol.toStringTag]() { return "TypeSet"; }
    }
    Encoder.TypeSet = TypeSet;
})(Encoder || (Encoder = {}));
var Encoder;
(function (Encoder) {
    function safe(func, msg, stack = false) {
        try {
            return func();
        }
        catch (ex) {
            throw `${msg} ${stack ? ex.stack : ""}`;
        }
    }
    Encoder.safe = safe;
    function reduce(obj) {
        if (obj && typeof obj === "object" && "toJSON" in obj)
            obj = obj.toJSON();
        if (!(typeof obj === "object" && obj !== null))
            return obj;
        const isArray = Array.isArray(obj);
        const res = isArray ? [] : {};
        for (const key in obj) {
            let value = obj[key];
            value = value && typeof value === "object" && "toJSON" in value ? value.toJSON() : value;
            if (typeof value === "object")
                value = reduce(value);
            if (isArray)
                res.push(value);
            else if (value !== null || value !== undefined)
                res[key] = value;
        }
        return res;
    }
    Encoder.reduce = reduce;
    function stringify(obj) {
        const data = reduce(obj);
        const json = require("util").inspect(data, {
            compact: true,
            breakLength: 100,
            maxArrayLength: null,
            depth: null
        });
        return json.replace(/"/g, "\\\"").replace(/'/g, '"').replace(/  /g, "\t");
    }
    Encoder.stringify = stringify;
})(Encoder || (Encoder = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW5jb2RlcmxpYi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL2xpYi9Db2RlLnRzIiwiLi4vbGliL0Z1dHVyZVR5cGUudHMiLCIuLi9saWIvUHJvdG90eXBlLnRzIiwiLi4vbGliL1RydXRoLnRzIiwiLi4vbGliL1R5cGUudHMiLCIuLi9saWIvVHlwZVNldC50cyIsIi4uL2xpYi9VdGlsLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxJQUFVLE9BQU8sQ0E4RWhCO0FBOUVELFdBQVUsT0FBTztJQUVoQixNQUFhLElBQUk7UUFBakI7WUFFQyxVQUFLLEdBQVcsRUFBRSxDQUFDO1lBQ25CLGVBQVUsR0FBZ0IsRUFBRSxDQUFDO1FBd0U5QixDQUFDO1FBdEVBLEdBQUcsQ0FBQyxJQUFVO1lBRWIsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQztnQkFDN0QsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXRDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNyQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQ3BCLE9BQU8sRUFBRSxDQUFDO1FBQ1gsQ0FBQztRQUVELElBQUk7WUFFSCxLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQzdCO2dCQUNDLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUM7Z0JBQ2pDLElBQUksU0FBUyxFQUNiO29CQUNDLE1BQU0sYUFBYSxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUM7b0JBQ3JDLElBQUksYUFBYTt3QkFDaEIsYUFBYSxDQUFDLFFBQVEsQ0FBQyxHQUFH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QyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFO1lBQzFDLE9BQU8sRUFBRSxJQUFJO1lBQ2IsV0FBVyxFQUFFLEdBQUc7WUFDaEIsY0FBYyxFQUFFLElBQUk7WUFDcEIsS0FBSyxFQUFFLElBQUk7U0FDWCxDQUFDLENBQUM7UUFDSCxPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztJQUMzRSxDQUFDO0lBVmUsaUJBQVMsWUFVeEIsQ0FBQTtBQUNGLENBQUMsRUFwRFMsT0FBTyxLQUFQLE9BQU8sUUFvRGhCIiwic291cmNlc0NvbnRlbnQiOlsibmFtZXNwYWNlIEVuY29kZXJcbntcblx0ZXhwb3J0IGNsYXNzIENvZGVcblx0e1xuXHRcdHR5cGVzOiBUeXBlW10gPSBbXTtcblx0XHRwcm90b3R5cGVzOiBQcm90b3R5cGVbXSA9IFtdO1xuXHRcblx0XHRhZGQodHlwZTogVHlwZSlcblx0XHR7XG5cdFx0XHRpZiAoIXRoaXMucHJvdG90eXBlcy5zb21lKHggPT4geC5oYXNoID09PSB0eXBlLnByb3RvdHlwZS5oYXNoKSlcblx0XHRcdFx0dGhpcy5wcm90b3R5cGVzLnB1c2godHlwZS5wcm90b3R5cGUpO1xuXHRcdFx0XHRcblx0XHRcdGNvbnN0IGlkID0gdGhpcy50eXBlcy5wdXNoKHR5cGUpIC0gMTtcblx0XHRcdHR5cGUudHJhbnNmZXIodGhpcyk7XG5cdFx0XHRyZXR1cm4gaWQ7XG5cdFx0fVxuXHRcdFxuXHRcdGxpbmsoKVxuXHRcdHtcblx0XHRcdGZvciAoY29uc3QgdHlwZSBvZiB0aGlzLnR5cGVzKVxuXHRcdFx0e1xuXHRcdFx0XHRjb25zdCBjb250YWluZXIgPSB0eXBlLmNvbnRhaW5lcjtcblx0XHRcdFx0aWYgKGNvbnRhaW5lcikgXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRjb25zdCBjb250YWluZXJUeXBlID0gY29udGFpbmVyLnR5cGU7XG5cdFx0XHRcdFx0aWYgKGNvbnRhaW5lclR5cGUpXG5cdFx0XHRcdFx0XHRjb250YWluZXJUeXBlLmNvbnRlbnRzLmFkZChGdXR1cmVUeXBlLiQodHlwZSkpO1xuXHRcdFx0XHR9XG5cdFx0XHR9XG5cdFx0fVxuXHRcdFxuXHRcdGV4dHJhY3REYXRhKHBhdHRlcm46IFJlZ0V4cClcblx0XHR7XG5cdFx0XHRjb25zdCBkYXRhUm9vdHMgPSB0aGlzLnR5cGVzLmZpbHRlcih4ID0+IHguY29udGFpbmVyID09PSBudWxsICYmIHBhdHRlcm4udGVzdCh4Lm5hbWUpKTtcblx0XHRcdFxuXHRcdFx0Y29uc3QgZHJpbGwgPSAoeDogVHlwZSkgPT5cblx0XHRcdHtcblx0XHRcdFx0Y29uc3QgYXJyYXkgPSBbeF07XG5cdFx0XHRcdGZvciAoY29uc3QgY29udGVudCBvZiB4LmNvbnRlbnRzKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0Y29uc3QgdHlwZSA9IGNvbnRlbnQudHlwZTtcblx0XHRcdFx0XHRpZiAodHlwZSlcblx0XHRcdFx0XHR7XG5cdFx0XHRcdFx0XHRjb25zdCBjaGlsZCA9IGRyaWxsKHR5cGUpLmZsYXQoKTtcblx0XHRcdFx0XHRcdGlmIChjaGlsZC5sZW5ndGgpXG5cdFx0XHRcdFx0XHRcdGFycmF5LnB1c2goLi4uY2hpbGQpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fSBcblx0XHRcdFx0cmV0dXJuIGFycmF5O1xuXHRcdFx0fTtcblx0XHRcdFxuXHRcdFx0Y29uc3QgZGF0YVNjaGVtYSA9IGRhdGFSb290cy5tYXAoZHJpbGwpLmZpbHRlcih4ID0+IEFycmF5LmlzQXJyYXkoeCkgPyB4Lmxlbmd0aCA6IHRydWUpO1xuXHRcdFx0Y29uc3QgZGF0YVF1ZXJ5ID0gZGF0YVNjaGVtYS5mbGF0KCk7XG5cdFx0XHRjb25zdCBjb2RlUm9vdHMgPSB0aGlzLnR5cGVzLmZpbHRlcih4ID0+ICFkYXRhUXVlcnkuaW5jbHVkZXMoeCkpO1xuXHRcdFx0Y29uc3QgY29kZSA9IG5ldyBDb2RlKCk7XG5cdFx0XHRmb3IgKGNvbnN0IHR5cGUgb2YgY29kZVJvb3RzKVxuXHRcdFx0XHRjb2RlLmFkZCh0eXBlKTtcblx0XHRcdFx0XG5cdFx0XHRmb3IgKGNvbnN0IHR5cGUgb2YgZGF0YVF1ZXJ5KVxuXHRcdFx0e1x0XHRcdFxuXHRcdFx0XHRpZiAoIWNvZGUucHJvdG90eXBlcy5zb21lKHggPT4geC5oYXNoID09PSB0eXBlLnByb3RvdHlwZS5oYXNoKSlcblx0XHRcdFx0XHRjb2RlLnByb3RvdHlwZXMucHVzaCh0eXBlLnByb3RvdHlwZSk7XHRcblx0XHRcdFx0dHlwZS50cmFuc2Zlcihjb2RlKTtcblx0XHRcdH1cblx0XHRcblx0XHRcdGNvbnN0IGRhdGEgPSBkYXRhU2NoZW1hLm1hcCh4ID0+IFt4Lm1hcCh4ID0+IHgucHJvdG90eXBlLmlkKSwgeFswXS5uYW1lLCAuLi54Lm1hcCh4ID0+IHguYWxpYXNlcyldKTtcblx0XHRcdFx0XHRcdFx0XG5cdFx0XHRyZXR1cm4ge1xuXHRcdFx0XHRjb2RlLFxuXHRcdFx0XHRkYXRhXG5cdFx0XHR9XG5cdFx0fVxuXHRcdFxuXHRcdHRvSlNPTigpIHsgcmV0dXJuIFt0aGlzLnByb3RvdHlwZXMsIHRoaXMudHlwZXNdOyB9XG5cdFx0dmFsdWVPZigpIHsgcmV0dXJuIHRoaXMudHlwZXMubGVuZ3RoOyB9XG5cdFx0W1N5bWJvbC50b1ByaW1pdGl2ZV0oKSB7IHJldHVybiB0aGlzLnR5cGVzLmxlbmd0aDsgfVxuXHRcdGdldCBbU3ltYm9sLnRvU3RyaW5nVGFnXSgpIHsgcmV0dXJuIFwiQ29kZVwiOyB9XG5cdH1cbn0iLCJcbm5hbWVzcGFjZSBFbmNvZGVyIFxue1xuXHRleHBvcnQgdHlwZSBUeXBlaXNoID0gVHJ1dGguVHlwZSB8wqBUeXBlIHwgbnVtYmVyO1xuXHRcblx0ZXhwb3J0IGNsYXNzIEZ1dHVyZVR5cGVcblx0e1xuXHRcdHN0YXRpYyBDYWNoZSA9IG5ldyBNYXA8VHlwZWlzaCwgRnV0dXJlVHlwZT4oKTtcblx0XHRzdGF0aWMgVHlwZU1hcCA9IG5ldyBNYXA8VHJ1dGguVHlwZSwgVHlwZT4oKTtcblx0XHRzdGF0aWMgSWRNYXAgPSBuZXcgTWFwPG51bWJlciwgVHlwZT4oKTtcblx0XHRcblx0XHRzdGF0aWMgJCh2YWx1ZTogVHlwZWlzaClcblx0XHR7XG5cdFx0XHRjb25zdCBjYWNoZWQgPSBGdXR1cmVUeXBlLkNhY2hlLmdldCh2YWx1ZSk7XG5cdFx0XHRcblx0XHRcdGlmIChjYWNoZWQpXG5cdFx0XHRcdHJldHVybiBjYWNoZWQ7XG5cdFx0XHRcdFxuXHRcdFx0Y29uc3QgaW5zdGFuY2UgPSBuZXcgRnV0dXJlVHlwZSh2YWx1ZSk7XG5cdFx0XHRGdXR1cmVUeXBlLkNhY2hlLnNldCh2YWx1ZSwgaW5zdGFuY2UpO1xuXHRcdFx0XG5cdFx0XHRyZXR1cm4gaW5zdGFuY2U7XG5cdFx0fSBcblx0XHRcblx0XHRjb25zdHJ1Y3Rvcihwcml2YXRlIHZhbHVlOiBUeXBlaXNoKSB7IH1cblx0XHQgXG5cdFx0Z2V0IHR5cGUoKVxuXHRcdHtcblx0XHRcdGlmICh0aGlzLnZhbHVlIGluc3RhbmNlb2YgVHJ1dGguVHlwZSlcblx0XHRcdHtcblx0XHRcdFx0Y29uc3QgdHlwZSA9IEZ1dHVyZVR5cGUuVHlwZU1hcC5nZXQodGhpcy52YWx1ZSk7XG5cdFx0XHRcdGlmICghdHlwZSkgXG5cdFx0XHRcdFx0cmV0dXJuIG51bGw7XG5cdFx0XHRcdHJldHVybiB0eXBlO1xuXHRcdFx0fVxuXHRcdFx0XG5cdFx0XHRpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFR5cGUpXG5cdFx0XHRcdHJldHVybiB0aGlzLnZhbHVlO1xuXHRcdFx0XHRcblx0XHRcdHJldHVybiBGdXR1cmVUeXBlLklkTWFwLmdldCh0aGlzLnZhbHVlKSB8fCBudWxsO1xuXHRcdH1cblx0XHRcblx0XHRnZXQgaWQoKVxuXHRcdHtcblx0XHRcdGlmICh0aGlzLnZhbHVlIGluc3RhbmNlb2YgVHJ1dGguVHlwZSlcblx0XHRcdHtcblx0XHRcdFx0Y29uc3QgdHlwZSA9IEZ1dHVyZVR5cGUuVHlwZU1hcC5nZXQodGhpcy52YWx1ZSk7XG5cdFx0XHRcdGlmICghdHlwZSkgXG5cdFx0XHRcdFx0cmV0dXJuIC0xO1xuXHRcdFx0XHRyZXR1cm4gdHlwZS5pZDtcblx0XHRcdH1cblx0XHRcdFxuXHRcdFx0aWYgKHRoaXMudmFsdWUgaW5zdGFuY2VvZiBUeXBlKVxuXHRcdFx0XHRyZXR1cm4gdGhpcy52YWx1ZS5pZDtcblx0XHRcdFx0XG5cdFx0XHRyZXR1cm4gdGhpcy52YWx1ZTtcblx0XHR9XG5cdFx0XG5cdFx0aXModHlwZTogVHlwZSlcblx0XHR7XG5cdFx0XHRjb25zdCB2YWx1ZVR5cGUgPSB0aGlzLnZhbHVlO1xuXHRcdFx0aWYgKCF2YWx1ZVR5cGUpIHJldHVybiBmYWxzZTtcblx0XHRcdHJldHVybiB2YWx1ZVR5cGUgPT09IHR5cGU7XHRcblx0XHR9XG5cdFx0XG5cdFx0dG9KU09OKCkgeyByZXR1cm4gdGhpcy5pZDsgfVxuXHRcdHZhbHVlT2YoKSB7IHJldHVybiB0aGlzLmlkOyB9XG5cdFx0W1N5bWJvbC50b1ByaW1pdGl2ZV0oKSB7IHJldHVybiB0aGlzLmlkOyB9XG5cdFx0Z2V0IFtTeW1ib2wudG9TdHJpbmdUYWddKCkgeyByZXR1cm4gXCJGdXR1cmVUeXBlXCI7IH1cblx0fVxufSIsIm5hbWVzcGFjZSBFbmNvZGVyIFxue1xuXHRleHBvcnQgY2xhc3MgUHJvdG90eXBlIFxuXHR7XG5cdFx0XG5cdFx0c3RhdGljIGZyb21UcnV0aChjb2RlOiBDb2RlLCB0eXBlOiBUcnV0aC5UeXBlKVxuXHRcdHtcblx0XHRcdGNvbnN0IGZsYWdzID0gbmV3IEJhY2tlci5CaXRmaWVsZHMoKTtcblx0XHRcdFxuXHRcdFx0ZmxhZ3Muc2V0KDAsIHR5cGUuaXNBbm9ueW1vdXMpO1xuXHRcdFx0ZmxhZ3Muc2V0KDEsIHR5cGUuaXNGcmVzaCk7XG5cdFx0XHRmbGFncy5zZXQoMiwgdHlwZS5pc0xpc3QpO1xuXHRcdFx0ZmxhZ3Muc2V0KDMsIHR5cGUuaXNMaXN0SW50cmluc2ljKTtcblx0XHRcdGZsYWdzLnNldCg0LCB0eXBlLmlzTGlzdEV4dHJpbnNpYyk7XG5cdFx0XHRmbGFncy5zZXQoNSwgdHlwZS5pc1BhdHRlcm4pO1xuXHRcdFx0ZmxhZ3Muc2V0KDYsIHR5cGUuaXNVcmkpO1xuXHRcdFx0ZmxhZ3Muc2V0KDcsIHR5cGUuaXNTcGVjaWZpZWQpO1xuXHRcdFx0XG5cdFx0XHRsZXQgcHJvdG8gPSBuZXcgUHJvdG90eXBlKFxuXHRcdFx0XHRjb2RlLCBcblx0XHRcdFx0ZmxhZ3MsXG5cdFx0XHRcdG5ldyBUeXBlU2V0KHR5cGUuYmFzZXMubWFwKEZ1dHVyZVR5cGUuJCkpLFxuXHRcdFx0XHRuZXcgVHlwZVNldCh0eXBlLnBhdHRlcm5zLm1hcChGdXR1cmVUeXBlLiQpKSxcblx0XHRcdFx0bmV3IFR5cGVTZXQodHlwZS5wYXJhbGxlbHMubWFwKEZ1dHVyZVR5cGUuJCkpLFxuXHRcdFx0XHRuZXcgVHlwZVNldCh0eXBlLmNvbnRlbnRzSW50cmluc2ljLm1hcChGdXR1cmVUeXBlLiQpKVxuXHRcdFx0KTtcblx0XHRcdFxuXHRcdFx0Y29uc3QgZXggPSBjb2RlLnByb3RvdHlwZXMuZmluZCh4ID0+IHguaGFzaCA9PT0gcHJvdG8uaGFzaCk7XG5cdFx0XHRcblx0XHRcdGlmIChleCkgXG5cdFx0XHRcdHByb3RvID0gZXg7XG5cdFx0XHRcdFxuXHRcdFx0cmV0dXJuIHByb3RvO1xuXHRcdH1cblx0XHRcblx0XHRjb25zdHJ1Y3Rvcihcblx0XHRcdHByaXZhdGUgY29kZTogQ29kZSxcblx0XHRcdHB1YmxpYyBmbGFnczogQmFja2VyLkJpdGZpZWxkcyxcblx0XHRcdFxuXHRcdFx0cHVibGljIGJhc2VzID0gbmV3IFR5cGVTZXQoKSxcblx0XHRcdHB1YmxpYyBwYXR0ZXJucyA9IG5ldyBUeXBlU2V0KCksXG5cdFx0XHRwdWJsaWMgcGFyYWxsZWxzID0gbmV3IFR5cGVTZXQoKSxcblx0XHRcdHB1YmxpYyBjb250ZW50c0ludHJpbnNpYyA9IG5ldyBUeXBlU2V0KCkpIHt9XG5cdFx0XHRcblx0XHRnZXQgaWQoKVxuXHRcdHtcblx0XHRcdHJldHVybiB0aGlzLmNvZGUucHJvdG90eXBlcy5pbmRleE9mKHRoaXMpO1xuXHRcdH1cblx0XHRcblx0XHRnZXQgaGFzaCgpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIEJhY2tlci5VdGlsLmhhc2goSlNPTi5zdHJpbmdpZnkodGhpcykpO1xuXHRcdH1cblx0XHRcblx0XHR0cmFuc2Zlcihjb2RlOiBDb2RlKVxuXHRcdHtcblx0XHRcdHRoaXMuY29kZSA9IGNvZGU7XG5cdFx0fVxuXHRcdFxuXHRcdHRvSlNPTigpXG5cdFx0e1x0XG5cdFx0XHRyZXR1cm4gQmFja2VyLlNlcmlhbGl6ZXIuZW5jb2RlKFtcblx0XHRcdFx0dGhpcy5mbGFncywgdGhpcy5iYXNlcywgdGhpcy5wYXR0ZXJucywgdGhpcy5wYXJhbGxlbHMsIHRoaXMuY29udGVudHNJbnRyaW5zaWNcblx0XHRcdF0pO1xuXHRcdH1cdFx0XG5cdH1cbn0iLCJcbm5hbWVzcGFjZSBFbmNvZGVyXG57XG5cdGV4cG9ydCBjb25zdCBIZWFkZXIgPSBcIlwiO1xuXG5cdFxuXHRleHBvcnQgYXN5bmMgZnVuY3Rpb24gY29tcGlsZShjb25maWdQYXRoOiBzdHJpbmcpXG5cdHtcblx0XHRjb25zdCBqb2luID0gcmVxdWlyZShcInBhdGhcIikuam9pbiBhcyB0eXBlb2YgaW1wb3J0KFwicGF0aFwiKS5qb2luO1xuXHRcdGlmICghY29uZmlnUGF0aC5lbmRzV2l0aChcInRydXRoY29uZmlnLmpzXCIpKSBjb25maWdQYXRoID0gam9pbihjb25maWdQYXRoLCBcIi90cnV0aGNvbmZpZy5qc1wiKTtcblx0XHRcblx0XHRjb25zdCBjb25maWcgPSBzYWZlKCgpID0+IHJlcXVpcmUoY29uZmlnUGF0aCksIFwiQ291bGRuJ3QgcmVhZCBjb25maWcgZmlsZSFcIikgYXMge1xuXHRcdFx0XHRCYWNrZXI6IGJvb2xlYW47XG5cdFx0XHRcdFNvdXJjZURpcjogc3RyaW5nO1xuXHRcdFx0XHRUYXJnZXREaXI6IHN0cmluZztcblx0XHRcdFx0RGF0YVBhdHRlcm5zOiBSZWNvcmQ8c3RyaW5nLCBSZWdFeHA+XG5cdFx0fTtcblx0XHRcblx0XHRjb25zdCB0cnV0aGZpbGVzID0gc2FmZSgoKSA9PiBcblx0XHRcdFRydXRoLkZzLm1vZHVsZS5yZWFkZGlyU3luYyhqb2luKHByb2Nlc3MuY3dkKCksIGNvbmZpZy5Tb3VyY2VEaXIpKSwgXG5cdFx0XHRcIkNvdWxkbid0IHJlYWQgc291cmNlIGZvbGRlciFcIiwgdHJ1ZVxuXHRcdCkuZmlsdGVyKHggPT4geC5lbmRzV2l0aChcIi50cnV0aFwiKSk7XG5cdFx0Y29uc3QgY29udGVudCA9IFtcblx0XHRcdGNvbmZpZy5CYWNrZXIgPyBIZWFkZXIgOiBcIlwiLCBcblx0XHRcdC4uLnRydXRoZmlsZXMubWFwKHggPT4gc2FmZShcblx0XHRcdFx0KCkgPT4gVHJ1dGguRnMubW9kdWxlLnJlYWRGaWxlU3luYyhqb2luKHByb2Nlc3MuY3dkKCksIHgpLCBcInV0Zi04XCIpLFxuXHRcdFx0XHRcIkNvdWxkbid0IHJlYWQgdHJ1dGggZmlsZSFcIlxuXHRcdFx0KSldLmpvaW4oXCJcXG5cIik7XG5cdFx0XG5cdFx0Y29uc3QgZG9jdW1lbnQgPSBhd2FpdCBUcnV0aC5wYXJzZShjb250ZW50KTtcblx0XHRcblx0XHRkb2N1bWVudC5wcm9ncmFtLnZlcmlmeSgpO1xuXHRcdFxuXHRcdGZvciAoY29uc3QgZmF1bHQgb2YgZG9jdW1lbnQucHJvZ3JhbS5mYXVsdHMuZWFjaCgpKVxuXHRcdFx0Y29uc29sZS5lcnJvcihmYXVsdC50b1N0cmluZygpKTtcblx0XHRcblx0XHRsZXQgY29kZSA9IG5ldyBDb2RlKCk7XG5cdFx0XG5cdFx0Y29uc3QgZHJpbGwgPSAodHlwZTogVHJ1dGguVHlwZSkgPT4gXG5cdFx0e1xuXHRcdFx0Y29kZS5hZGQoVHlwZS5mcm9tVHJ1dGgoY29kZSwgdHlwZSkpO1xuXHRcdFx0Zm9yIChjb25zdCBzdWIgb2YgdHlwZS5jb250ZW50cylcblx0XHRcdFx0ZHJpbGwoc3ViKTtcblx0XHR9O1xuXHRcdFxuXHRcdGZvciAoY29uc3QgdHlwZSBvZiBkb2N1bWVudC50eXBlcylcblx0XHRcdGRyaWxsKHR5cGUpO1xuXHRcdFx0XG5cdFx0Y29kZS5saW5rKCk7XG5cdFx0XHRcblx0XHRmb3IgKGNvbnN0IGtleSBpbiBjb25maWcuRGF0YVBhdHRlcm5zKVxuXHRcdHtcblx0XHRcdGxldCB0ZW1wID0gY29kZS5leHRyYWN0RGF0YShjb25maWcuRGF0YVBhdHRlcm5zW2tleV0pO1xuXHRcdFx0Y29kZSA9IHRlbXAuY29kZTtcblx0XHRcdHNhZmUoKCkgPT4gVHJ1dGguRnMubW9kdWxlLndyaXRlRmlsZVN5bmMoXG5cdFx0XHRcdGpvaW4ocHJvY2Vzcy5jd2QoKSwgY29uZmlnLlRhcmdldERpciwga2V5ICsgXCIuZGF0YS5qc29uXCIpLCBcblx0XHRcdFx0c3RyaW5naWZ5KHRlbXAuZGF0YSlcblx0XHRcdCksIFwiQ291bGRuJ3QgcmVhZCBzb3VyY2UgZm9sZGVyIVwiLCB0cnVlKTtcblx0XHR9XG5cdFxuXHRcdHNhZmUoKCkgPT4gVHJ1dGguRnMubW9kdWxlLndyaXRlRmlsZVN5bmMoXG5cdFx0XHRqb2luKHByb2Nlc3MuY3dkKCksIGNvbmZpZy5UYXJnZXREaXIsIFwiY29kZS5qc29uXCIpLFxuXHRcdFx0c3RyaW5naWZ5KGNvZGUpXG5cdFx0KSwgXCJDb3VsZG4ndCByZWFkIHNvdXJjZSBmb2xkZXIhXCIsIHRydWUpO1xuXHRcdFx0IFxuXHR9XG59ICAiLCJcbm5hbWVzcGFjZSBFbmNvZGVyXG57XG5cdGV4cG9ydCBjbGFzcyBUeXBlXG5cdHtcblx0XHRzdGF0aWMgZnJvbVRydXRoKGNvZGU6IENvZGUsIHR5cGU6IFRydXRoLlR5cGUpXG5cdFx0e1x0XG5cdFx0XHRjb25zdCBpbnN0YW5jZSA9IG5ldyBUeXBlKFxuXHRcdFx0XHRjb2RlLCBcblx0XHRcdFx0dHlwZS5pc1BhdHRlcm4gPyB0eXBlLm5hbWUuc3Vic3RyKDkpIDogdHlwZS5uYW1lLCBcblx0XHRcdFx0UHJvdG90eXBlLmZyb21UcnV0aChjb2RlLCB0eXBlKSxcblx0XHRcdFx0dHlwZS5jb250YWluZXIgPyBGdXR1cmVUeXBlLiQodHlwZS5jb250YWluZXIpIDogbnVsbCxcblx0XHRcdFx0dHlwZS5hbGlhc2VzIGFzIHN0cmluZ1tdXG5cdFx0XHQpO1xuXHRcdFx0XG5cdFx0XHRGdXR1cmVUeXBlLlR5cGVNYXAuc2V0KHR5cGUsIGluc3RhbmNlKTtcblx0XHRcdHJldHVybiBpbnN0YW5jZTtcblx0XHR9XG5cdFx0XG5cdFx0Y29uc3RydWN0b3IoXG5cdFx0XHRwcml2YXRlIGNvZGU6IENvZGUsXG5cdFx0XHRwdWJsaWMgbmFtZTogc3RyaW5nLFxuXHRcdFx0cHVibGljIHByb3RvdHlwZTogUHJvdG90eXBlLFxuXHRcdFx0cHVibGljIGNvbnRhaW5lcjogRnV0dXJlVHlwZSB8IG51bGwgPSBudWxsLFxuXHRcdFx0XG5cdFx0XHRwdWJsaWMgYWxpYXNlczogc3RyaW5nW10gPSBbXSkge31cblx0XHRcdFxuXHRcdHB1YmxpYyBjb250ZW50cyA9IG5ldyBUeXBlU2V0KCk7XG5cdFx0XHRcblx0XHRnZXQgaWQoKVxuXHRcdHtcblx0XHRcdHJldHVybiB0aGlzLmNvZGUudHlwZXMuaW5kZXhPZih0aGlzKTtcblx0XHR9XG5cdFx0XG5cdFx0dHJhbnNmZXIoY29kZTogQ29kZSlcblx0XHR7XG5cdFx0XHR0aGlzLmNvZGUgPSBjb2RlO1xuXHRcdFx0dGhpcy5wcm90b3R5cGUudHJhbnNmZXIoY29kZSk7XG5cdFx0fVxuXHRcdFxuXHRcdHRvSlNPTigpXG5cdFx0e1x0XG5cdFx0XHRyZXR1cm4gW3RoaXMucHJvdG90eXBlLmlkLCB0aGlzLmNvbnRhaW5lciwgdGhpcy5uYW1lLCB0aGlzLmFsaWFzZXNdO1xuXHRcdH1cblx0fVxufSIsIlxubmFtZXNwYWNlIEVuY29kZXJcbntcblx0ZXhwb3J0IGNsYXNzIFR5cGVTZXQgZXh0ZW5kcyBTZXQ8RnV0dXJlVHlwZT5cblx0e1xuXHRcdHRvQXJyYXkoKVxuXHRcdHtcblx0XHRcdHJldHVybiBBcnJheS5mcm9tKHRoaXMudmFsdWVzKCkpLnNvcnQoKTtcdFxuXHRcdH1cblx0XHRcblx0XHR0b0pTT04oKSB7IHJldHVybiB0aGlzLnRvQXJyYXkoKTsgfVxuXHRcdHZhbHVlT2YoKSB7IHJldHVybiB0aGlzLnRvQXJyYXkoKTsgfVxuXHRcdFtTeW1ib2wudG9QcmltaXRpdmVdKCkgeyByZXR1cm4gdGhpcy50b0FycmF5KCk7IH1cblx0XHRnZXQgW1N5bWJvbC50b1N0cmluZ1RhZ10oKSB7IHJldHVybiBcIlR5cGVTZXRcIjsgfVxuXHR9XG59IiwiXG5uYW1lc3BhY2UgRW5jb2RlciBcbntcblx0ZXhwb3J0IGZ1bmN0aW9uIHNhZmU8VD4oZnVuYzogKC4uLmFyZ3M6IGFueVtdKSA9PiBULCBtc2c6IHN0cmluZywgc3RhY2sgPSBmYWxzZSk6IFRcblx0e1xuXHRcdHRyeSBcblx0XHR7XG5cdFx0XHRyZXR1cm4gZnVuYygpO1xuXHRcdH1cblx0XHRjYXRjaCAoZXgpXG5cdFx0e1xuXHRcdFx0dGhyb3cgYCR7bXNnfSAke3N0YWNrID8gZXguc3RhY2sgOiBcIlwifWA7XG5cdFx0fVxuXHR9XG5cdFxuXHRleHBvcnQgZnVuY3Rpb24gcmVkdWNlKG9iajogYW55KVxuXHR7XG5cdFx0aWYgKG9iaiAmJiB0eXBlb2Ygb2JqID09PSBcIm9iamVjdFwiICYmIFwidG9KU09OXCIgaW4gb2JqKSBcblx0XHRcdG9iaiA9IG9iai50b0pTT04oKTsgXG5cdFx0XHRcblx0XHRpZiAoISh0eXBlb2Ygb2JqID09PSBcIm9iamVjdFwiICYmwqBvYmogIT09IG51bGwpKSBcblx0XHRcdHJldHVybiBvYmo7XG5cdFx0XHRcblx0XHRjb25zdCBpc0FycmF5ID0gQXJyYXkuaXNBcnJheShvYmopO1xuXHRcdGNvbnN0IHJlcyA9IGlzQXJyYXkgPyBbXSA6IHt9IGFzIFJlY29yZDxzdHJpbmcsIGFueT47XG5cdFx0XHRcblx0XHRmb3IgKGNvbnN0IGtleSBpbiBvYmopXG5cdFx0e1xuXHRcdFx0bGV0IHZhbHVlID0gb2JqW2tleV07XG5cdFx0XHR2YWx1ZSA9IHZhbHVlICYmIHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIiAmJiBcInRvSlNPTlwiIGluIHZhbHVlID8gdmFsdWUudG9KU09OKCkgOiB2YWx1ZTtcblx0XHRcdFxuXHRcdFx0aWYgKHR5cGVvZiB2YWx1ZSA9PT0gXCJvYmplY3RcIikgXG5cdFx0XHRcdHZhbHVlID0gcmVkdWNlKHZhbHVlKTtcblx0XHRcdFxuXHRcdFx0aWYgKGlzQXJyYXkpXG5cdFx0XHRcdHJlcy5wdXNoKHZhbHVlKTtcblx0XHRcdGVsc2UgaWYgKHZhbHVlICE9PSBudWxsIHx8wqB2YWx1ZSAhPT0gdW5kZWZpbmVkKSBcblx0XHRcdFx0cmVzW2tleV0gPSB2YWx1ZTtcblx0XHR9XG5cdFx0cmV0dXJuIHJlcztcblx0fVx0XG5cdFxuXHRleHBvcnQgZnVuY3Rpb24gc3RyaW5naWZ5KG9iajogYW55KVxuXHR7XG5cdFx0Y29uc3QgZGF0YSA9IHJlZHVjZShvYmopO1xuXHRcdGNvbnN0IGpzb24gPSByZXF1aXJlKFwidXRpbFwiKS5pbnNwZWN0KGRhdGEsIHtcblx0XHRcdGNvbXBhY3Q6IHRydWUsXG5cdFx0XHRicmVha0xlbmd0aDogMTAwLFxuXHRcdFx0bWF4QXJyYXlMZW5ndGg6IG51bGwsXG5cdFx0XHRkZXB0aDogbnVsbFxuXHRcdH0pO1xuXHRcdHJldHVybiBqc29uLnJlcGxhY2UoL1wiL2csIFwiXFxcXFxcXCJcIikucmVwbGFjZSgvJy9nLCAnXCInKS5yZXBsYWNlKC8gIC9nLCBcIlxcdFwiKTtcblx0fVxufSJdfQ==